<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="RetroWalk - Every step echoes a story. An interactive 3D portfolio museum experience">
    <meta name="author" content="Portfolio Owner">
    <title>RetroWalk</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/bubbles.css">
    <link rel="stylesheet" href="css/content-panel.css">
    <link rel="stylesheet" href="css/loading-page.css">
    <link rel="stylesheet" href="css/visual-enhancements.css">
    <link rel="stylesheet" href="css/fallback.css">
</head>
<body>
    <!-- Skip to content link for accessibility -->
    <a href="#museum-space" class="skip-link">Skip to content</a>
    
    <!-- Welcome Screen -->
    <div id="welcome-screen" class="welcome-screen">
        <div class="welcome-content">
            <h1 class="welcome-title">RetroWalk</h1>
            <p class="welcome-subtitle">Every step echoes a story</p>
            <button id="enter-btn" class="enter-button">Enter</button>
        </div>
    </div>
    
    <!-- Main container -->
    <main id="app" class="app-container" role="main">
        <!-- Museum space for 3D transforms -->
        <div id="museum-space" class="museum-space" aria-label="Interactive 3D portfolio space">
            <!-- Center 3D Title -->
            <div class="center-title">NYERK</div>
            
            <!-- Bubbles will be dynamically inserted here -->
        </div>
        
        <!-- Content panel overlay -->
        <aside id="content-panel" class="content-panel" role="dialog" aria-modal="true" aria-hidden="true">
            <button class="close-btn" aria-label="Close content panel">&times;</button>
            <div class="content-body">
                <img class="content-image" src="" alt="" loading="lazy">
                <h2 class="content-title"></h2>
                <p class="content-description"></p>
            </div>
            <div class="content-actions">
                <button class="content-button">View Details</button>
                <button class="content-button">Contact</button>
            </div>
        </aside>
        
        <!-- Backdrop overlay -->
        <div class="backdrop" aria-hidden="true"></div>
        
        <!-- Loading Page -->
        <div id="loading-page" class="loading-page" aria-hidden="true">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <h2 class="loading-title">Entering Memory Hall...</h2>
            </div>
        </div>
    </main>
    
    <!-- White fade transition overlay -->
    <div class="white-fade-overlay"></div>
    
    <!-- Three.js Library -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
        }
    }
    </script>
    
    <!-- JavaScript Files -->
    <script src="js/utils.js"></script>
    <script src="js/config.js"></script>
    <script src="js/AudioManager.js"></script>
    <script src="js/VisualEffects.js"></script>
    <script src="js/BubbleManager.js"></script>
    <script src="js/CameraController.js"></script>
    <script src="js/ContentPanel.js"></script>
    <script src="js/InteractionHandler.js"></script>
    <script src="js/PortfolioMuseum.js"></script>
    <script type="module">
        // Import Detail View
        import { DetailView } from './js/threejs/DetailView.js';
        
        // Initialize Detail View
        const detailView = new DetailView();
        detailView.init();
        
        // Store globally
        window.detailView = detailView;
        
        // Connect to "Enter Memory Hall" button
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const enterButton = document.querySelector('.content-panel .content-button:first-child');
                console.log('Looking for Enter button:', enterButton);
                
                if (enterButton) {
                    enterButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('Enter button clicked!');
                        
                        // Get accent color from content panel
                        const contentPanel = document.getElementById('content-panel');
                        const accentColor = getComputedStyle(contentPanel).getPropertyValue('--bubble-color') || '#FF69B4';
                        console.log('Accent color:', accentColor);
                        
                        // Get current portfolio item from the panel's data attribute
                        const portfolioId = contentPanel.dataset.portfolioId;
                        console.log('Portfolio ID:', portfolioId);
                        
                        const portfolioItem = window.portfolioData?.find(item => item.id == portfolioId);
                        console.log('Portfolio item:', portfolioItem);
                        
                        // Close content panel
                        const closeBtn = contentPanel.querySelector('.close-btn');
                        if (closeBtn) closeBtn.click();
                        
                        // Show detail view after panel closes
                        setTimeout(() => {
                            console.log('Showing detail view...');
                            detailView.show(accentColor, portfolioItem);
                        }, 400);
                    });
                    
                    console.log('Detail View connected to Enter button');
                } else {
                    console.error('Enter button not found!');
                }
            }, 1000);
        });
    </script>
    <script>
        /**
         * Main initialization script for 3D Bubble Portfolio Museum
         * Initializes the application on DOM ready with error handling
         */
        document.addEventListener('DOMContentLoaded', () => {
            // Handle welcome screen
            const welcomeScreen = document.getElementById('welcome-screen');
            const enterBtn = document.getElementById('enter-btn');
            const museumSpace = document.getElementById('museum-space');
            
            // Initialize Audio Manager early (on page load)
            const audioManager = new AudioManager();
            audioManager.init('assets/audio/background-music.mp3');
            
            // Initialize Visual Effects
            const visualEffects = new VisualEffects();
            visualEffects.init();
            
            // Store globally for debugging
            window.audioManager = audioManager;
            window.visualEffects = visualEffects;
            
            // Initially hide museum space
            museumSpace.style.opacity = '0';
            
            // Enter button click handler
            enterBtn.addEventListener('click', () => {
                // Start background music when user clicks Enter
                audioManager.play();
                
                // Fade out welcome screen
                welcomeScreen.classList.add('hidden');
                
                // Fade in museum space after welcome screen fades
                setTimeout(() => {
                    museumSpace.style.transition = 'opacity 1s ease';
                    museumSpace.style.opacity = '1';
                    
                    // Initialize the museum after animation
                    initializeMuseum(audioManager);
                }, 400);
            });
            
            // Function to initialize the museum
            function initializeMuseum(audioManager) {
                // Get container element
                const container = document.getElementById('museum-space');
                if (!container) {
                    console.error('Museum space container not found');
                    return;
                }
                
                // Validate portfolio data exists
                if (typeof portfolioData === 'undefined') {
                    console.error('Portfolio data not loaded');
                    container.innerHTML = 
                        '<p style="color: white; text-align: center; padding: 2rem;">' +
                        'Portfolio data failed to load. Please refresh the page.</p>';
                    return;
                }
                
                // Validate portfolio data structure
                if (typeof validatePortfolioData === 'function') {
                    const validation = validatePortfolioData(portfolioData);
                    if (!validation.isValid) {
                        console.error('Portfolio data validation failed:', validation.errors);
                        container.innerHTML = 
                            '<p style="color: white; text-align: center; padding: 2rem;">' +
                            'Portfolio data is invalid. Please check the console for details.</p>';
                        return;
                    }
                }
                
                // Check minimum data requirements
                if (!Array.isArray(portfolioData) || portfolioData.length < 1) {
                    console.error('Portfolio data must be a non-empty array');
                    container.innerHTML = 
                        '<p style="color: white; text-align: center; padding: 2rem;">' +
                        'No portfolio items found. Please add portfolio data.</p>';
                    return;
                }
                
                // Initialize Portfolio Museum with error handling
                try {
                    const museum = new PortfolioMuseum({
                        container: container,
                        data: portfolioData
                    });
                    
                    museum.init();
                    
                    console.log(`Portfolio Museum initialized with ${portfolioData.length} items`);
                    
                    // Store museum instance globally for debugging
                    window.portfolioMuseum = museum;
                    
                } catch (error) {
                    console.error('Failed to initialize Portfolio Museum:', error);
                    container.innerHTML = 
                        '<p style="color: white; text-align: center; padding: 2rem;">' +
                        'Failed to load portfolio: ' + error.message + '<br>' +
                        'Please refresh the page or check the console for details.</p>';
                }
            }
        });
    </script>
</body>
</html>
